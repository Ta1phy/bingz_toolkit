name: 跨平台打包

# 添加权限设置
permissions:
  contents: write

# 触发条件：推送到main分支 或 正式发布Release
on:
  push:
    branches: [ master ]  # 仅main分支推送时触发（开发调试用）
  release:
    types: [ published ]  # 仅正式发布Release时触发（正式交付用）

jobs:
  build:
    # 构建矩阵：多平台+指定Python版本，并行构建
    strategy:
      fail-fast: false  # 一个平台构建失败，不影响其他平台继续运行（便于排错）
      matrix:
        os: [ windows-latest, macos-latest ]  # 打包平台：Windows最新版、macOS最新版
        python-version: [ '3.13' ]  # 匹配项目的Python版本（可按需修改为3.10、3.12等）

    # 运行环境：对应矩阵中的操作系统
    runs-on: ${{ matrix.os }}

    steps:
      # 步骤1：检出仓库代码到GitHub Actions构建环境
      - name: 检出代码
        uses: actions/checkout@v4  # 官方检出动作，稳定可靠
        
      - name: 设置 Windows 终端编码为 UTF-8
        if: matrix.os == 'windows-latest'  # 仅对 Windows 环境生效
        run: |
          chcp 65001  # Windows 命令：切换终端编码为 UTF-8（65001 对应 UTF-8）
          set PYTHONIOENCODING=utf-8  # 设置 Python 环境变量，强制使用 UTF-8 编码
        shell: cmd
        
      # 步骤2：设置指定版本的Python环境，开启pip缓存（优化构建时间）
      - name: 设置Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'  # 缓存pip依赖，后续构建无需重新下载

      # 步骤3：升级pip并安装项目依赖+PyInstaller
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 步骤4：运行build.py打包脚本，生成产物到dist/目录
      - name: 运行打包脚本（Windows）
        if: matrix.os == 'windows-latest'
        run: |
          python build.py > build_output.txt 2>&1
          echo "build.py执行完成，输出已保存到build_output.txt"
          type build_output.txt
        shell: cmd

      - name: 运行打包脚本（macOS）
        if: matrix.os == 'macos-latest'
        run: |
          python build.py
        shell: bash

      # 步骤5：添加详细调试信息，检查目录结构
      - name: 检查当前目录结构（所有平台）
        if: matrix.os == 'windows-latest'
        run: |
          echo "当前工作目录: ${{ github.workspace }}"
          dir
        shell: cmd

      - name: 检查当前目录结构（macOS）
        if: matrix.os == 'macos-latest'
        run: |
          echo "当前工作目录: ${{ github.workspace }}"
          ls -la
        shell: bash

      - name: 检查dist目录内容（Windows）
        if: matrix.os == 'windows-latest'
        run: |
          if exist "dist" (
            echo "dist目录存在，内容："
            dir dist\
          ) else (
            echo "ERROR: dist目录不存在！"
            echo "当前目录下的所有目录："
            dir /b /ad
            echo "执行build.py的输出："
            type build_output.txt 2>nul || echo "没有build_output.txt"
          )
        shell: cmd

      - name: 检查dist目录内容（macOS）
        if: matrix.os == 'macos-latest'
        run: |
          if [ -d "dist" ]; then
            echo "dist目录存在，内容："
            ls -la dist/
          else
            echo "ERROR: dist目录不存在！"
            # 检查是否有其他可能的输出目录
            echo "当前目录下的所有目录："
            find . -type d -name "*dist*" -o -name "*build*"
          fi
        shell: bash

      # 步骤6：上传产物到Artifact（临时存储，开发调试用）
      - name: 上传临时产物（Artifact - Windows）
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: BingZwindows-latest
          path: |
            dist\*
            .\dist\*
            **\dist\*
          retention-days: 30
          if-no-files-found: warn

      - name: 上传临时产物（Artifact - macOS）
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: BingZmacos-latest
          path: |
            dist/
            ./dist/
            **/dist/*
          retention-days: 30
          if-no-files-found: warn

      # 步骤7：上传产物到最新Release Assets（push和release事件都触发）
      - name: 获取最新Release标签
        id: get_latest_release
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            if (releases.data.length > 0) {
              core.setOutput('tag_name', releases.data[0].tag_name);
            } else {
              core.setOutput('tag_name', 'v1.0.0'); // 如果没有Release，使用默认标签
            }

      - name: 上传产物到最新Release Assets（Windows）
        if: matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag_name }}
          files: |
            dist\*
            .\dist\*
            **\dist\*
          overwrite_files: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传产物到最新Release Assets（macOS）
        if: matrix.os == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_latest_release.outputs.tag_name }}
          files: |
            dist/
            ./dist/
            **/dist/*
          overwrite_files: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
